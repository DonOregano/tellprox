<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>JQuery TellProxy Example</title>
    <link type="text/css" href="static/css/ui-lightness/jquery-ui-1.8.23.custom.css" rel="Stylesheet" />
    <script type="text/javascript" src="static/js/jquery-1.8.0.min.js"></script>
    <script type="text/javascript" src="static/js/jquery-ui-1.8.23.custom.min.js"></script>
    <style>
    .amountInput {
      border:0;
    }

    input, label {
      font-family: Trebuchet MS, Verdana;
      font-size: 12px;
      border: 0;
    }

    </style>
  </head>
  <body>
	<div id="sliders" style="width: 350px; margin:0 auto"></div>
    <script>
	var URLBase = 'json/';
	var ON_OFF = 3;
	var DIM = 16;
	
	$(document).ready(function(){
        var sliders = $('#sliders');
        $.ajax({
			url: URLBase + 'devices/list',
			dataType: "jsonp",
			crossDomain: true,
			success: function(data) {
				loadItems(data);
			}
      	});
	});

	function loadItems(data) {
		var allItems = [];
		var devices = data['device']
		
		// Loop through all items
		jQuery.each(devices, function(i, v) {
			// Check it supports dimming
			var dimmable = ((v.methods & DIM) == DIM)
			// Create elements
			allItems[v.id] = {
				label: jQuery('<label/>', {
					for: 'amount'+v.id,
					text: v.name + ': ',
					data: {"i": v.id}
				}),
				input: jQuery('<input/>', {
					type: 'text',
					id: 'amount'+v.id,
					value: calcPercentage(v.statevalue),
					class: 'amountInput',
					data: {"i": v.id}
				}),
				slider: jQuery('<div/>', {
					id: 'item'+v.id,
					data: {"i": v.id}
				})
			   .slider({
					range: "min",
					value: v.statevalue,
					min: 0,
					max: dimmable ? 254 : 1,
					animate: true,
					slide: function( event, ui ) {
						var id = $(this).data("i");
						var newval = dimmable ? calcPercentage(ui.value) : (ui.value * 100) + '%'
						allItems[id].input.val(newval);
					},
					change: function(event, ui) {
						var id = $(this).data("i");
						var req = {
							url: URLBase + 'device/',
							dataType: "jsonp",
							data: {id: id},
							crossDomain: true
						}
						if (ui.value == 0 || ui.value >= 254 || !dimmable) {
							req['url'] += 'turn' + ((ui.value == 0) ? 'Off' : 'On');
							$.ajax(req);
						} else {
							req['url'] += 'dim';
							req['data']['level'] = ui.value;
							$.ajax(req);
						}
					}
				})
			};
			
			// Add items to sliders div
			allItems[v.id].label
			.add(allItems[v.id].input)
			.add(allItems[v.id].slider)
			.appendTo(sliders);
		});
	}

	function calcPercentage(input) {
		return Math.floor(100 * input / 254) + "%";
	}
    </script>
  </body>
</html>